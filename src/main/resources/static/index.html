<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento MTX - ALC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #000;
            color: #f00;
        }
        h1 {
            color: #f00;
            margin: 20px 0 10px 0;
        }
        .casa {
            display: inline-block;
            width: 20%;
            margin: 10px;
            padding: 15px;
            border: 2px solid #f00;
            background: #111;
            color: #f00;
            text-align: center;
            vertical-align: top;
            border-radius: 8px;
        }
        .casa h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #f00;
        }
        .casa p {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        /* Nova classe para a casa grande */
        .casa-grande {
            border: 3px solid #f00;
            background: #111;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .casa-grande h1 {
            margin-bottom: 15px;
            align-self: center;
        }
        .casa-grande .casas-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            width: 100%;
        }

        /* Container para dropdowns dentro das casas grandes */
        .casa-grande .dropdowns-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            position: static;
            top: auto;
            right: auto;
        }

        /* Containers para os dropdowns */
        .dropdowns-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .dropdown-container {
            position: relative;
        }

        .dropdown-btn {
            padding: 8px 15px;
            background: transparent;
            color: #f00;
            border: 2px solid #f00;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
        }

        .dropdown-btn:hover {
            background: #f00;
            color: #000;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 35px;
            background: #111;
            border: 2px solid #f00;
            border-radius: 4px;
            min-width: 120px;
            padding: 5px 0;
            z-index: 1001;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 15px;
            color: #f00;
            cursor: pointer;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background: #f00;
            color: #000;
        }

        .dropdown-item.selected {
            background: #f00;
            color: #000;
            font-weight: bold;
        }

        .dropdown-divider {
            height: 1px;
            background: #f00;
            margin: 5px 0;
        }

        #status {
            margin-top: 20px;
            color: #0f0;
            font-weight: bold;
            padding: 10px;
            background: #111;
            border-radius: 5px;
            text-align: center;
        }

        /* Status message para pot√™ncia e canal */
        .potencia-status, .canal-status {
            margin: 10px auto;
            padding: 8px 12px;
            background: #111;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            text-align: center;
            max-width: 80%;
        }

        .status-success {
            color: #0f0;
            border: 1px solid #0f0;
        }

        .status-error {
            color: #f00;
            border: 1px solid #f00;
        }

        .status-loading {
            color: #f00;
            border: 1px solid #f00;
        }

        /* Container para loop */
        .loop-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .loop-btn {
            padding: 6px 12px;
            background: transparent;
            color: #f00;
            border: 2px solid #f00;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .loop-btn:hover {
            background: #f00;
            color: #000;
        }

        .loop-btn.ativo {
            background: #f00;
            color: #000;
        }

        .loop-btn.parar {
            color: #f00;
            border: 2px solid #f00;
        }

        .loop-btn.parar:hover {
            background: #f00;
            color: #000;
        }

        /* Status do loop */
        .loop-status {
            margin: 10px auto;
            padding: 8px 12px;
            background: #111;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            text-align: center;
            max-width: 80%;
        }

        @media (max-width: 768px) {
            .casa {
                width: 45%;
            }
            .casa-grande {
                padding: 10px;
            }
            .casa-grande .casas-container {
                flex-direction: column;
            }
            .dropdowns-container {
                top: 10px;
                right: 10px;
                flex-direction: column;
                gap: 5px;
            }
            .casa-grande .dropdowns-container {
                flex-direction: column;
                gap: 5px;
            }
            .loop-container {
                gap: 5px;
            }
            .loop-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        /* Bot√µes de Status MTX (mesmo estilo do loop) */
        .status-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .status-btn {
            padding: 6px 12px;
            background: transparent;
            color: #f00;
            border: 2px solid #f00;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .status-btn:hover {
            background: #f00;
            color: #000;
        }

        .status-btn.ativo {
            background: #000;
            color: #0f0;
        }

        .status-btn.desligar {
            color: #f00;
            border: 2px solid #f00;
        }

        .status-btn.desligar:hover {
            background: #f00;
            color: #000;
        }

        .status-btn.desligar.ativo {
            background: #f00;
            color: #000;
        }

        /* Container para pot√™ncia/calibra√ß√£o */
        .potencia-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

         /* Container para lineariza√ß√£o */
        .linearizacao-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

         /* Container para pot√™ncia geral */
        .potencia-geral-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        /* Container para procedimento completo */
        .procedimento-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .procedimento-btn {
            padding: 8px 16px;
            background: transparent;
            color: #f00;
            border: 2px solid #f00;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .procedimento-btn:hover {
            background: #f00;
            color: #000;
        }

        .procedimento-btn.ativo {
            background: #f00;
            color: #000;
        }

        .procedimento-btn.parar {
            color: #f00;
            border: 2px solid #f00;
        }

        .procedimento-btn.parar:hover {
            background: #f00;
            color: #000;
        }

        .tentar-novamente-btn {
            margin-top: 5px;
            padding: 3px 8px;
            background-color: #f00;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .tentar-novamente-btn:hover {
            background-color: #c00;
        }

        /* Container para todos os canais */
        .procedimento-todos-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        /* Container para todos os canais */
        .procedimento-completo-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .procedimento-todos-btn {
            padding: 8px 16px;
            background: transparent;
            color: #f00;
            border: 2px solid #f00;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .procedimento-todos-btn:hover {
            background: #f00;
            color: #000;
        }

        .procedimento-todos-btn.ativo {
            background: #f00;
            color: #000;
        }

        .procedimento-todos-btn.parar {
            color: #f00;
            border: 2px solid #f00;
        }

        .procedimento-todos-btn.parar:hover {
            background: #f00;
            color: #000;
        }

        /* Classes adicionais para estilos din√¢micos */
        .status-warning {
            color: #ff9900;
            border: 1px solid #ff9900;
            background: #221a00;
        }

        .controle-geral-section {
            border: 3px solid #ff9900;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            background: #111;
        }

        .controle-geral-section h1 {
            color: #ff9900;
        }

        /* Estilos para containers de offset */
        .offset-config-container {
            margin: 15px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #f00;
            transition: all 0.3s;
        }

        .offset-config-container:hover {
            border-color: #ff3333;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .offset-config-container h3 {
            color: #f00;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* Inputs de offset */
        .offset-input {
            padding: 6px 10px;
            border: 1px solid #f00;
            border-radius: 4px;
            width: 150px;
            background: #000;
            color: #fff;
            font-family: monospace;
        }

        .offset-input:focus {
            outline: none;
            border-color: #ff3333;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        /* Bot√µes de aplicar offset */
        .offset-btn {
            padding: 6px 12px;
            background: #f00;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .offset-btn:hover {
            background: #ff3333;
            transform: translateY(-1px);
        }

        /* Mensagens de status */
        .offset-status {
            margin: 5px 0 0 0;
            font-style: italic;
            font-size: 12px;
            min-height: 20px;
        }

        /* Adicione ao seu CSS existente */
        .offset-input:disabled {
            background: #333;
            color: #888;
            cursor: not-allowed;
        }

        .offset-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .offset-btn.loading {
            background: #ff9900;
            color: #000;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Estilos para bot√µes de cancelamento */
        .emergencia-container {
            margin: 15px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 3px solid #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        .emergencia-container h3 {
            color: #ff0000;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
        }

        .emergencia-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-cancelar-offset {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff3333, #cc0000);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-cancelar-offset:hover {
            background: linear-gradient(135deg, #ff6666, #ff0000);
            transform: scale(1.05);
        }

        .btn-cancelar-linearizacao {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff6600, #cc5200);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-cancelar-linearizacao:hover {
            background: linear-gradient(135deg, #ff8844, #ff6600);
            transform: scale(1.05);
        }

        .btn-cancelar-tudo {
            padding: 8px 16px;
            background: linear-gradient(135deg, #990000, #660000);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-cancelar-tudo:hover {
            background: linear-gradient(135deg, #cc0000, #990000);
            transform: scale(1.05);
        }

        .status-cancelamento {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<!-- Dropdown de Atualiza√ß√£o -->
<div class="dropdowns-container">
    <div class="dropdown-container">
        <button class="dropdown-btn" onclick="toggleDropdown('Atualizar')">Atualizar: 1m</button>
        <div class="dropdown-content" id="dropdownAtualizar">
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" onclick="setIntervalo(30000)">30s</button>
            <button class="dropdown-item" onclick="setIntervalo(60000)">1m</button>
            <button class="dropdown-item" onclick="setIntervalo(120000)">2m</button>
            <button class="dropdown-item" onclick="setIntervalo(180000)">3m</button>
            <button class="dropdown-item" onclick="setIntervalo(300000)">5m</button>
            <button class="dropdown-item" onclick="setIntervalo(600000)">10m</button>
            <button class="dropdown-item" onclick="setIntervalo(900000)">15m</button>
            <button class="dropdown-item" onclick="setIntervalo(1800000)">30m</button>
            <button class="dropdown-item" onclick="setIntervalo(3600000)">1h</button>
            <button class="dropdown-item" onclick="setIntervalo(21600000)">6h</button>
            <button class="dropdown-item" onclick="setIntervalo(43200000)">12h</button>
            <button class="dropdown-item" onclick="desativarAtualizacao()">Disabled</button>
        </div>
    </div>
</div>

<h1>Calibra√ß√£o Autom√°tica 1.3</h1>

<!-- MTX 1 -->
<div class="casa-grande" id="mtx1">
    <h1>MTX1</h1>

    <!-- BOT√ïES DE CANCELAMENTO DE EMERG√äNCIA -->
    <div class="emergencia-container">
        <h3>üö® CANCELAMENTO DE EMERG√äNCIA - MTX1</h3>

        <div class="emergencia-buttons">
            <button class="btn-cancelar-offset" onclick="cancelarOffsetMtx1()">
                ‚èπÔ∏è CANCELAR OFFSET
            </button>

            <button class="btn-cancelar-linearizacao" onclick="cancelarLinearizacaoMtx1()">
                üõë CANCELAR LINEARIZA√á√ÉO
            </button>

            <button class="btn-cancelar-tudo" onclick="cancelarTudoMtx1()">
                üö® CANCELAR TUDO
            </button>
        </div>

        <div id="statusCancelamentoMTX1" class="status-cancelamento"></div>
    </div>

    <div class="dropdowns-container">
        <!-- Dropdown de Pot√™ncia -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Potencia1')" id="potenciaBtn1">Pot√™ncia: 1W</button>
            <div class="dropdown-content" id="dropdownPotencia1">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('1', '300', '1W')">1W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('1', '340', '2.5W')">2.5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('1', '370', '5W')">5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('1', '430', '20W')">20W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('1', '486', '67.3W')">67.3W</button>
            </div>
        </div>

        <!-- Dropdown de Canal -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Canal1')" id="canalBtn1">Canal: 14</button>
            <div class="dropdown-content" id="dropdownCanal1">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarCanalDropdown('1', '14', '14')">14</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('1', '34', '34')">34</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('1', '51', '51')">51</button>
            </div>
        </div>
    </div>

    <div class="potencia-status" id="potenciaStatus1"></div>
    <div class="canal-status" id="canalStatus1"></div>

    <!-- Container para bot√µes de status (Ligar/Desligar) -->
    <div class="status-container">
        <button class="loop-btn" onclick="ligarMTX('1')" id="ligarBtn1">
            LIGAR
        </button>
        <button class="loop-btn parar" onclick="desligarMTX('1')" id="desligarBtn1" style="display: none;">
            DESLIGAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO PARA CANAL ATUAL -->
    <div class="procedimento-todos-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCanalAtual('1')" id="procedimentoCanalBtn1">
            ROTINA PRINCIPAL CANAL ATUAL
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCanalAtual('1')"
                id="cancelarProcedimentoCanalBtn1" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO COMPLETO -->
    <div class="procedimento-completo-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCompleto('1')" id="procedimentoCompletoBtn1">
            ROTINA PRINCIPAL COMPLETA
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCompleto('1')"
                id="cancelarProcedimentoCompletoBtn1" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para OFFSET PARA CANAL ATUAL -->
    <div class="potencia-geral-container">
        <button class="loop-btn" onclick="iniciarOffsetCanalAtual('1')" id="comecarOffsetCanalBtn1">
            OFFSET CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarOffsetCanalAtual('1')" id="pararOffsetCanalBtn1"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Container para LINEARIZA√á√ÉO PARA CANAL ATUAL -->
    <div class="linearizacao-container">
        <button class="loop-btn" onclick="iniciarLinearizacaoCanalAtual('1')" id="comecarLinearizacaoCanalBtn1">
            LINEARIZA√á√ÉO CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarLinearizacaoCanalAtual('1')" id="pararLinearizacaoCanalBtn1"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Status Messages -->
    <div class="loop-status" id="loopStatus1"></div>
    <div class="loop-status" id="mtxStatus1"></div>
    <div class="loop-status" id="loopPotencia1"></div>
    <div class="loop-status" id="loopPotenciageral1"></div>
    <div class="loop-status" id="loopLinearizacao1"></div>
    <div class="loop-status" id="procedimentoStatus1"></div>
    <div class="loop-status" id="procedimentoTodosStatus1"></div>
    <div id="offsetMtx1Status" class="loop-status" style="margin: 10px auto; max-width: 90%; display: none;"></div>

    <!-- Container para CONFIGURAR OFFSET INICIAL MTX1 -->
    <div class="offset-config-container"
         style="margin: 20px 0; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #f00;">
        <h3 style="color: #f00; margin-bottom: 10px;">CONFIGURA√á√ÉO DE OFFSET INICIAL - MTX1</h3>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-weight: bold; min-width: 120px; color: #fff;">Offset inicial:</span>
            <input type="number" id="offsetInicialMtx1"
                   style="padding: 6px 10px; border: 1px solid #f00; border-radius: 4px; width: 150px; background: #000; color: #fff;"
                   placeholder="Digite o offset"
                   min="-32768" max="32767" step="1" value="0">
            <button onclick="aplicarOffsetMTX('1')" id="btnAplicarOffsetMTX1"
                    style="padding: 6px 12px; background: #f00; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Aplicar Offset
            </button>
        </div>

        <div style="background: #111; padding: 8px; border-radius: 4px; border: 1px solid #333;">
            <p id="offsetStatusMtx1" style="margin: 0; font-style: italic; font-size: 12px; color: #666;"></p>
        </div>
    </div>

    <div class="casas-container">
        <div class="casa">
            <h3>Canal</h3>
            <p id="chanelNumber1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Frequ√™ncia</h3>
            <p id="frequency1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Forward dBM</h3>
            <p id="forwardDBM1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Status ALC</h3>
            <p id="statusAlc1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Output DAC</h3>
            <p id="valorOutputDac1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Desired DAC</h3>
            <p id="valorDesiredDac1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Direta</h3>
            <p id="potencia1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Refletida</h3>
            <p id="refletida1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Temperatura</h3>
            <p id="temperatura1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 1</h3>
            <p id="fan1MTX1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 2</h3>
            <p id="fan2MTX1">Carregando...</p>
        </div>
        <div class="casa">
            <h3>OffSet</h3>
            <p id="offSetMtx1">Carregando...</p>
        </div>
    </div>
</div>

<!-- MTX 2 -->
<div class="casa-grande" id="mtx2">
    <h1>MTX2</h1>

    <!-- BOT√ïES DE CANCELAMENTO DE EMERG√äNCIA -->
    <div class="emergencia-container">
        <h3>üö® CANCELAMENTO DE EMERG√äNCIA - MTX2</h3>

        <div class="emergencia-buttons">
            <button class="btn-cancelar-offset" onclick="cancelarOffsetMtx2()">
                ‚èπÔ∏è CANCELAR OFFSET
            </button>

            <button class="btn-cancelar-linearizacao" onclick="cancelarLinearizacaoMtx2()">
                üõë CANCELAR LINEARIZA√á√ÉO
            </button>

            <button class="btn-cancelar-tudo" onclick="cancelarTudoMtx2()">
                üö® CANCELAR TUDO
            </button>
        </div>

        <div id="statusCancelamentoMTX2" class="status-cancelamento"></div>
    </div>

    <div class="dropdowns-container">
        <!-- Dropdown de Pot√™ncia -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Potencia2')" id="potenciaBtn2">Pot√™ncia: 1W</button>
            <div class="dropdown-content" id="dropdownPotencia2">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('2', '300', '1W')">1W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('2', '340', '2.5W')">2.5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('2', '370', '5W')">5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('2', '430', '20W')">20W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('2', '486', '67.3W')">67.3W</button>
            </div>
        </div>

        <!-- Dropdown de Canal -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Canal2')" id="canalBtn2">Canal: 14</button>
            <div class="dropdown-content" id="dropdownCanal2">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarCanalDropdown('2', '14', '14')">14</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('2', '34', '34')">34</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('2', '51', '51')">51</button>
            </div>
        </div>
    </div>

    <div class="potencia-status" id="potenciaStatus2"></div>
    <div class="canal-status" id="canalStatus2"></div>

    <!-- Container para bot√µes de status (Ligar/Desligar) -->
    <div class="status-container">
        <button class="loop-btn" onclick="ligarMTX('2')" id="ligarBtn2">
            LIGAR
        </button>
        <button class="loop-btn parar" onclick="desligarMTX('2')" id="desligarBtn2" style="display: none;">
            DESLIGAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO PARA CANAL ATUAL -->
    <div class="procedimento-todos-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCanalAtual('2')" id="procedimentoCanalBtn2">
            ROTINA PRINCIPAL CANAL ATUAL
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCanalAtual('2')"
                id="cancelarProcedimentoCanalBtn2" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO COMPLETO -->
    <div class="procedimento-completo-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCompleto('2')" id="procedimentoCompletoBtn2">
            ROTINA PRINCIPAL COMPLETA
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCompleto('2')"
                id="cancelarProcedimentoCompletoBtn2" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para OFFSET PARA CANAL ATUAL -->
    <div class="potencia-geral-container">
        <button class="loop-btn" onclick="iniciarOffsetCanalAtual('2')" id="comecarOffsetCanalBtn2">
            OFFSET CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarOffsetCanalAtual('2')" id="pararOffsetCanalBtn2"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Container para LINEARIZA√á√ÉO PARA CANAL ATUAL -->
    <div class="linearizacao-container">
        <button class="loop-btn" onclick="iniciarLinearizacaoCanalAtual('2')" id="comecarLinearizacaoCanalBtn2">
            LINEARIZA√á√ÉO CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarLinearizacaoCanalAtual('2')" id="pararLinearizacaoCanalBtn2"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Status Messages -->
    <div class="loop-status" id="loopStatus2"></div>
    <div class="loop-status" id="mtxStatus2"></div>
    <div class="loop-status" id="loopPotencia2"></div>
    <div class="loop-status" id="loopPotenciageral2"></div>
    <div class="loop-status" id="loopLinearizacao2"></div>
    <div class="loop-status" id="procedimentoStatus2"></div>
    <div class="loop-status" id="procedimentoTodosStatus2"></div>

    <!-- Container para CONFIGURAR OFFSET INICIAL MTX2 -->
    <div class="offset-config-container"
         style="margin: 20px 0; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #f00;">
        <h3 style="color: #f00; margin-bottom: 10px;">CONFIGURA√á√ÉO DE OFFSET INICIAL - MTX2</h3>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-weight: bold; min-width: 120px; color: #fff;">Offset inicial:</span>
            <input type="number" id="offsetInicialMtx2"
                   style="padding: 6px 10px; border: 1px solid #f00; border-radius: 4px; width: 150px; background: #000; color: #fff;"
                   placeholder="Digite o offset"
                   min="-32768" max="32767" step="1" value="0">
            <button onclick="aplicarOffsetMTX('2')" id="btnAplicarOffsetMTX2"
                    style="padding: 6px 12px; background: #f00; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Aplicar Offset
            </button>
        </div>

        <div style="background: #111; padding: 8px; border-radius: 4px; border: 1px solid #333;">
            <p id="offsetStatusMtx2" style="margin: 0; font-style: italic; font-size: 12px; color: #666;"></p>
        </div>
    </div>

    <div class="casas-container">
        <div class="casa">
            <h3>Canal</h3>
            <p id="chanelNumber2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Frequ√™ncia</h3>
            <p id="frequency2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Forward dBM</h3>
            <p id="forwardDBM2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Status ALC</h3>
            <p id="statusAlc2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Output DAC</h3>
            <p id="valorOutputDac2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Desired DAC</h3>
            <p id="valorDesiredDac2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Direta</h3>
            <p id="potencia2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Refletida</h3>
            <p id="refletida2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Temperatura</h3>
            <p id="temperatura2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 1</h3>
            <p id="fan1MTX2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 2</h3>
            <p id="fan2MTX2">Carregando...</p>
        </div>
        <div class="casa">
            <h3>OffSet</h3>
            <p id="offSetMtx2">Carregando...</p>
        </div>
    </div>
</div>

<!-- MTX 3 -->
<div class="casa-grande" id="mtx3">
    <h1>MTX3</h1>

    <!-- BOT√ïES DE CANCELAMENTO DE EMERG√äNCIA -->
    <div class="emergencia-container">
        <h3>üö® CANCELAMENTO DE EMERG√äNCIA - MTX3</h3>

        <div class="emergencia-buttons">
            <button class="btn-cancelar-offset" onclick="cancelarOffsetMtx3()">
                ‚èπÔ∏è CANCELAR OFFSET
            </button>

            <button class="btn-cancelar-linearizacao" onclick="cancelarLinearizacaoMtx3()">
                üõë CANCELAR LINEARIZA√á√ÉO
            </button>

            <button class="btn-cancelar-tudo" onclick="cancelarTudoMtx3()">
                üö® CANCELAR TUDO
            </button>
        </div>

        <div id="statusCancelamentoMTX3" class="status-cancelamento"></div>
    </div>

    <div class="dropdowns-container">
        <!-- Dropdown de Pot√™ncia -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Potencia3')" id="potenciaBtn3">Pot√™ncia: 1W</button>
            <div class="dropdown-content" id="dropdownPotencia3">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('3', '300', '1W')">1W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('3', '340', '2.5W')">2.5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('3', '370', '5W')">5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('3', '430', '20W')">20W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('3', '486', '67.3W')">67.3W</button>
            </div>
        </div>

        <!-- Dropdown de Canal -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Canal3')" id="canalBtn3">Canal: 14</button>
            <div class="dropdown-content" id="dropdownCanal3">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarCanalDropdown('3', '14', '14')">14</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('3', '34', '34')">34</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('3', '51', '51')">51</button>
            </div>
        </div>
    </div>

    <div class="potencia-status" id="potenciaStatus3"></div>
    <div class="canal-status" id="canalStatus3"></div>

    <!-- Container para bot√µes de status (Ligar/Desligar) -->
    <div class="status-container">
        <button class="loop-btn" onclick="ligarMTX('3')" id="ligarBtn3">
            LIGAR
        </button>
        <button class="loop-btn parar" onclick="desligarMTX('3')" id="desligarBtn3" style="display: none;">
            DESLIGAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO PARA CANAL ATUAL -->
    <div class="procedimento-todos-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCanalAtual('3')" id="procedimentoCanalBtn3">
            ROTINA PRINCIPAL CANAL ATUAL
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCanalAtual('3')"
                id="cancelarProcedimentoCanalBtn3" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO COMPLETO -->
    <div class="procedimento-completo-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCompleto('3')" id="procedimentoCompletoBtn3">
            ROTINA PRINCIPAL COMPLETA
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCompleto('3')"
                id="cancelarProcedimentoCompletoBtn3" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para OFFSET PARA CANAL ATUAL -->
    <div class="potencia-geral-container">
        <button class="loop-btn" onclick="iniciarOffsetCanalAtual('3')" id="comecarOffsetCanalBtn3">
            OFFSET CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarOffsetCanalAtual('3')" id="pararOffsetCanalBtn3"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Container para LINEARIZA√á√ÉO PARA CANAL ATUAL -->
    <div class="linearizacao-container">
        <button class="loop-btn" onclick="iniciarLinearizacaoCanalAtual('3')" id="comecarLinearizacaoCanalBtn3">
            LINEARIZA√á√ÉO CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarLinearizacaoCanalAtual('3')" id="pararLinearizacaoCanalBtn3"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Status Messages -->
    <div class="loop-status" id="loopStatus3"></div>
    <div class="loop-status" id="mtxStatus3"></div>
    <div class="loop-status" id="loopPotencia3"></div>
    <div class="loop-status" id="loopPotenciageral3"></div>
    <div class="loop-status" id="loopLinearizacao3"></div>
    <div class="loop-status" id="procedimentoStatus3"></div>
    <div class="loop-status" id="procedimentoTodosStatus3"></div>

    <!-- Container para CONFIGURAR OFFSET INICIAL MTX3 -->
    <div class="offset-config-container"
         style="margin: 20px 0; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #f00;">
        <h3 style="color: #f00; margin-bottom: 10px;">CONFIGURA√á√ÉO DE OFFSET INICIAL - MTX3</h3>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-weight: bold; min-width: 120px; color: #fff;">Offset inicial:</span>
            <input type="number" id="offsetInicialMtx3"
                   style="padding: 6px 10px; border: 1px solid #f00; border-radius: 4px; width: 150px; background: #000; color: #fff;"
                   placeholder="Digite o offset"
                   min="-32768" max="32767" step="1" value="0">
            <button onclick="aplicarOffsetMTX('3')" id="btnAplicarOffsetMTX3"
                    style="padding: 6px 12px; background: #f00; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Aplicar Offset
            </button>
        </div>

        <div style="background: #111; padding: 8px; border-radius: 4px; border: 1px solid #333;">
            <p id="offsetStatusMtx3" style="margin: 0; font-style: italic; font-size: 12px; color: #666;"></p>
        </div>
    </div>

    <div class="casas-container">
        <div class="casa">
            <h3>Canal</h3>
            <p id="chanelNumber3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Frequ√™ncia</h3>
            <p id="frequency3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Forward dBM</h3>
            <p id="forwardDBM3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Status ALC</h3>
            <p id="statusAlc3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Output DAC</h3>
            <p id="valorOutputDac3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Desired DAC</h3>
            <p id="valorDesiredDac3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Direta</h3>
            <p id="potencia3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Refletida</h3>
            <p id="refletida3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Temperatura</h3>
            <p id="temperatura3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 1</h3>
            <p id="fan1MTX3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 2</h3>
            <p id="fan2MTX3">Carregando...</p>
        </div>
        <div class="casa">
            <h3>OffSet</h3>
            <p id="offSetMtx3">Carregando...</p>
        </div>
    </div>
</div>

<!-- MTX 4 -->
<div class="casa-grande" id="mtx4">
    <h1>MTX4</h1>

    <!-- BOT√ïES DE CANCELAMENTO DE EMERG√äNCIA -->
    <div class="emergencia-container">
        <h3>üö® CANCELAMENTO DE EMERG√äNCIA - MTX4</h3>

        <div class="emergencia-buttons">
            <button class="btn-cancelar-offset" onclick="cancelarOffsetMtx4()">
                ‚èπÔ∏è CANCELAR OFFSET
            </button>

            <button class="btn-cancelar-linearizacao" onclick="cancelarLinearizacaoMtx4()">
                üõë CANCELAR LINEARIZA√á√ÉO
            </button>

            <button class="btn-cancelar-tudo" onclick="cancelarTudoMtx4()">
                üö® CANCELAR TUDO
            </button>
        </div>

        <div id="statusCancelamentoMTX4" class="status-cancelamento"></div>
    </div>

    <div class="dropdowns-container">
        <!-- Dropdown de Pot√™ncia -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Potencia4')" id="potenciaBtn4">Pot√™ncia: 1W</button>
            <div class="dropdown-content" id="dropdownPotencia4">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('4', '300', '1W')">1W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('4', '340', '2.5W')">2.5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('4', '370', '5W')">5W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('4', '430', '20W')">20W</button>
                <button class="dropdown-item" onclick="setarPotenciaDropdown('4', '486', '67.3W')">67.3W</button>
            </div>
        </div>

        <!-- Dropdown de Canal -->
        <div class="dropdown-container">
            <button class="dropdown-btn" onclick="toggleDropdown('Canal4')" id="canalBtn4">Canal: 14</button>
            <div class="dropdown-content" id="dropdownCanal4">
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="setarCanalDropdown('4', '14', '14')">14</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('4', '34', '34')">34</button>
                <button class="dropdown-item" onclick="setarCanalDropdown('4', '51', '51')">51</button>
            </div>
        </div>
    </div>

    <div class="potencia-status" id="potenciaStatus4"></div>
    <div class="canal-status" id="canalStatus4"></div>

    <!-- Container para bot√µes de status (Ligar/Desligar) -->
    <div class="status-container">
        <button class="loop-btn" onclick="ligarMTX('4')" id="ligarBtn4">
            LIGAR
        </button>
        <button class="loop-btn parar" onclick="desligarMTX('4')" id="desligarBtn4" style="display: none;">
            DESLIGAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO PARA CANAL ATUAL -->
    <div class="procedimento-todos-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCanalAtual('4')" id="procedimentoCanalBtn4">
            ROTINA PRINCIPAL CANAL ATUAL
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCanalAtual('4')"
                id="cancelarProcedimentoCanalBtn4" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para PROCEDIMENTO COMPLETO -->
    <div class="procedimento-completo-container">
        <button class="procedimento-todos-btn" onclick="iniciarProcedimentoCompleto('4')" id="procedimentoCompletoBtn4">
            ROTINA PRINCIPAL COMPLETA
        </button>
        <button class="procedimento-todos-btn parar" onclick="cancelarProcedimentoCompleto('4')"
                id="cancelarProcedimentoCompletoBtn4" style="display: none;">
            CANCELAR
        </button>
    </div>

    <!-- Container para OFFSET PARA CANAL ATUAL -->
    <div class="potencia-geral-container">
        <button class="loop-btn" onclick="iniciarOffsetCanalAtual('4')" id="comecarOffsetCanalBtn4">
            OFFSET CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarOffsetCanalAtual('4')" id="pararOffsetCanalBtn4"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Container para LINEARIZA√á√ÉO PARA CANAL ATUAL -->
    <div class="linearizacao-container">
        <button class="loop-btn" onclick="iniciarLinearizacaoCanalAtual('4')" id="comecarLinearizacaoCanalBtn4">
            LINEARIZA√á√ÉO CANAL ATUAL
        </button>
        <button class="loop-btn parar" onclick="finalizarLinearizacaoCanalAtual('4')" id="pararLinearizacaoCanalBtn4"
                style="display: none;">
            PARAR
        </button>
    </div>

    <!-- Status Messages -->
    <div class="loop-status" id="loopStatus4"></div>
    <div class="loop-status" id="mtxStatus4"></div>
    <div class="loop-status" id="loopPotencia4"></div>
    <div class="loop-status" id="loopPotenciageral4"></div>
    <div class="loop-status" id="looplinearizacao4"></div>
    <div class="loop-status" id="procedimentoStatus4"></div>
    <div class="loop-status" id="procedimentoTodosStatus4"></div>

    <!-- Container para CONFIGURAR OFFSET INICIAL MTX4 -->
    <div class="offset-config-container"
         style="margin: 20px 0; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #f00;">
        <h3 style="color: #f00; margin-bottom: 10px;">CONFIGURA√á√ÉO DE OFFSET INICIAL - MTX4</h3>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-weight: bold; min-width: 120px; color: #fff;">Offset inicial:</span>
            <input type="number" id="offsetInicialMtx4"
                   style="padding: 6px 10px; border: 1px solid #f00; border-radius: 4px; width: 150px; background: #000; color: #fff;"
                   placeholder="Digite o offset"
                   min="-32768" max="32767" step="1" value="0">
            <button onclick="aplicarOffsetMTX('4')" id="btnAplicarOffsetMTX4"
                    style="padding: 6px 12px; background: #f00; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Aplicar Offset
            </button>
        </div>

        <div style="background: #111; padding: 8px; border-radius: 4px; border: 1px solid #333;">
            <p id="offsetStatusMtx4" style="margin: 0; font-style: italic; font-size: 12px; color: #666;"></p>
        </div>
    </div>

    <div class="casas-container">
        <div class="casa">
            <h3>Canal</h3>
            <p id="chanelNumber4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Frequ√™ncia</h3>
            <p id="frequency4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Forward dBM</h3>
            <p id="forwardDBM4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Status ALC</h3>
            <p id="statusAlc4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Output DAC</h3>
            <p id="valorOutputDac4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Desired DAC</h3>
            <p id="valorDesiredDac4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Direta</h3>
            <p id="potencia4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Potencia Refletida</h3>
            <p id="refletida4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>Temperatura</h3>
            <p id="temperatura4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 1</h3>
            <p id="fan1MTX4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>FAN 2</h3>
            <p id="fan2MTX4">Carregando...</p>
        </div>
        <div class="casa">
            <h3>OffSet</h3>
            <p id="offSetMtx4">Carregando...</p>
        </div>
    </div>
</div>

<div id="status">√öltima atualiza√ß√£o: Carregando...</div>

<script>
    // ============ VARI√ÅVEIS GLOBAIS ============
    let intervaloAtual = 30000;
    let atualizacaoAtiva = true;
    let timerAtualizacao = null;

    // Labels das pot√™ncias
    const powerLabels = {
        '300': '1W',
        '340': '2.5W',
        '370': '5W',
        '430': '20W',
        '486': '67.3W'
    };

    // Estado dos MTXs
    let mtxStatus = {
        '1': { ligado: false, canal: '14', potencia: '300' },
        '2': { ligado: false, canal: '14', potencia: '300' },
        '3': { ligado: false, canal: '14', potencia: '300' },
        '4': { ligado: false, canal: '14', potencia: '300' }
    };

    // Procedimentos ativos
    let procedimentoAtivo = {
        '1': false,
        '2': false,
        '3': false,
        '4': false
    };

    let offsetAtivo = {
        '1': false,
        '2': false,
        '3': false,
        '4': false
    };

    let linearizacaoAtivo = {
        '1': false,
        '2': false,
        '3': false,
        '4': false
    };

    // ============ VARI√ÅVEIS PARA MONITORAMENTO ============
    let pollingStatus = {
        '1': { ativo: false, tipo: null, intervalo: null },
        '2': { ativo: false, tipo: null, intervalo: null },
        '3': { ativo: false, tipo: null, intervalo: null },
        '4': { ativo: false, tipo: null, intervalo: null }
    };

    // ============ FUN√á√ïES DE CANCELAMENTO ============

    // Fun√ß√£o auxiliar para mostrar status de cancelamento
    function mostrarStatusCancelamento(mtx, mensagem, tipo) {
        const statusElement = document.getElementById(`statusCancelamentoMTX${mtx}`);
        if (!statusElement) return;

        statusElement.innerHTML = mensagem;
        statusElement.style.display = 'block';
        statusElement.style.padding = '10px';
        statusElement.style.borderRadius = '4px';
        statusElement.style.marginTop = '10px';

        if (tipo === 'success') {
            statusElement.style.background = '#1a3c1a';
            statusElement.style.color = '#4cff4c';
            statusElement.style.border = '1px solid #4cff4c';
        } else if (tipo === 'error') {
            statusElement.style.background = '#3c1a1a';
            statusElement.style.color = '#ff4c4c';
            statusElement.style.border = '1px solid #ff4c4c';
        } else if (tipo === 'warning') {
            statusElement.style.background = '#3c3c1a';
            statusElement.style.color = '#ffff4c';
            statusElement.style.border = '1px solid #ffff4c';
        }

        // Esconde ap√≥s 10 segundos
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 10000);
    }

    // ============ MTX 1 ============

    // Cancelar OFFSET para MTX1
    async function cancelarOffsetMtx1() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de OFFSET do MTX1?\n\nEsta a√ß√£o ir√° interromper imediatamente o ajuste de offset.')) {
            return;
        }

        mostrarStatusCancelamento('1', 'üîÑ Cancelando offset do MTX1...', 'warning');

        try {
            const response = await fetch('/cancelar-offset-mtx1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('1',
                    `‚úÖ OFFSET CANCELADO COM SUCESSO!\n\n` +
                    `Status: ${resultado.mensagem}\n` +
                    `Hora: ${resultado.hora_cancelamento}\n` +
                    `Thread interrompida: ${resultado.thread_interrompida ? 'SIM' : 'N√ÉO'}`,
                    'success'
                );

                // Resetar bot√µes de offset do MTX1
                resetarBotoesOffset('1');

            } else {
                mostrarStatusCancelamento('1',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\n` +
                    `Nenhum offset estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('1',
                `‚ùå ERRO DE CONEX√ÉO!\n\n` +
                `N√£o foi poss√≠vel cancelar o offset:\n${error.message}`,
                'error'
            );
            console.error('Erro ao cancelar offset MTX1:', error);
        }
    }

    // Cancelar LINEARIZA√á√ÉO para MTX1
    async function cancelarLinearizacaoMtx1() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de LINEARIZA√á√ÉO do MTX1?\n\nEsta a√ß√£o ir√° interromper imediatamente a lineariza√ß√£o em andamento.')) {
            return;
        }

        mostrarStatusCancelamento('1', 'üîÑ Cancelando lineariza√ß√£o do MTX1...', 'warning');

        try {
            const response = await fetch('/cancelar-linearizacao-mtx1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('1',
                    `‚úÖ LINEARIZA√á√ÉO CANCELADA COM SUCESSO!\n\n` +
                    `Status: ${resultado.mensagem}\n` +
                    `Hora: ${resultado.hora_cancelamento}\n` +
                    `Thread interrompida: ${resultado.thread_interrompida ? 'SIM' : 'N√ÉO'}`,
                    'success'
                );

                // Resetar bot√µes de lineariza√ß√£o do MTX1
                resetarBotoesLinearizacao('1');

            } else {
                mostrarStatusCancelamento('1',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\n` +
                    `Nenhuma lineariza√ß√£o estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('1',
                `‚ùå ERRO DE CONEX√ÉO!\n\n` +
                `N√£o foi poss√≠vel cancelar a lineariza√ß√£o:\n${error.message}`,
                'error'
            );
            console.error('Erro ao cancelar lineariza√ß√£o MTX1:', error);
        }
    }

    // Cancelar TUDO para MTX1
    async function cancelarTudoMtx1() {
        if (!confirm('üö®üö®üö® EMERG√äNCIA! üö®üö®üö®\n\nDeseja CANCELAR TODOS os processos do MTX1?\n\nEsta a√ß√£o ir√° interromper:\n‚Ä¢ Ajuste de OFFSET\n‚Ä¢ Processo de LINEARIZA√á√ÉO\n‚Ä¢ Qualquer outra rotina em execu√ß√£o\n\nATEN√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!')) {
            return;
        }

        mostrarStatusCancelamento('1', 'üö® CANCELANDO TODOS OS PROCESSOS DO MTX1...', 'error');

        try {
            // Tenta cancelar tudo
            let resultados = [];
            let cancelamentosEfetivos = 0;

            // 1. Cancelar Offset
            try {
                const offsetResponse = await fetch('/cancelar-offset-mtx1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const offsetResult = await offsetResponse.json();
                resultados.push({tipo: 'OFFSET', resultado: offsetResult});
                if (offsetResult.cancelamento_efetivo) cancelamentosEfetivos++;
            } catch (e) {
                resultados.push({tipo: 'OFFSET', erro: e.message});
            }

            // 2. Cancelar Lineariza√ß√£o
            try {
                const linearizacaoResponse = await fetch('/cancelar-linearizacao-mtx1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const linearizacaoResult = await linearizacaoResponse.json();
                resultados.push({tipo: 'LINEARIZA√á√ÉO', resultado: linearizacaoResult});
                if (linearizacaoResult.cancelamento_efetivo) cancelamentosEfetivos++;
            } catch (e) {
                resultados.push({tipo: 'LINEARIZA√á√ÉO', erro: e.message});
            }

            // 3. Cancelar procedimento geral (se houver endpoint)
            try {
                const procedimentoResponse = await fetch('/cancelar-procedimento-mtx1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (procedimentoResponse.ok) {
                    const procedimentoResult = await procedimentoResponse.json();
                    resultados.push({tipo: 'PROCEDIMENTO', resultado: procedimentoResult});
                    if (procedimentoResult.cancelamento_efetivo) cancelamentosEfetivos++;
                }
            } catch (e) {
                // Endpoint pode n√£o existir, isso √© normal
            }

            // Montar mensagem de resultado
            let mensagem = '';
            if (cancelamentosEfetivos > 0) {
                mensagem += `‚úÖ ${cancelamentosEfetivos} PROCESSO(S) CANCELADO(S)!\n\n`;
            } else {
                mensagem += `‚ö†Ô∏è NENHUM PROCESSO CANCELADO\n\n`;
            }

            mensagem += `RESULTADOS:\n`;
            resultados.forEach(r => {
                if (r.resultado) {
                    mensagem += `‚Ä¢ ${r.tipo}: ${r.resultado.mensagem}\n`;
                } else {
                    mensagem += `‚Ä¢ ${r.tipo}: Erro - ${r.erro}\n`;
                }
            });

            mostrarStatusCancelamento('1', mensagem,
                cancelamentosEfetivos > 0 ? 'success' : 'warning');

            // Resetar TODOS os bot√µes do MTX1
            resetarBotoesOffset('1');
            resetarBotoesLinearizacao('1');
            resetarBotoesProcedimento('1');
            resetarBotoesProcedimentoCompleto('1');

        } catch (error) {
            mostrarStatusCancelamento('1',
                `‚ùå ERRO CR√çTICO!\n\n` +
                `Falha ao tentar cancelar tudo:\n${error.message}`,
                'error'
            );
            console.error('Erro ao cancelar tudo MTX1:', error);
        }
    }

    // ============ MTX 2 ============

    // Cancelar OFFSET para MTX2
    async function cancelarOffsetMtx2() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de OFFSET do MTX2?')) {
            return;
        }

        mostrarStatusCancelamento('2', 'üîÑ Cancelando offset do MTX2...', 'warning');

        try {
            const response = await fetch('/cancelar-offset-mtx2', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('2',
                    `‚úÖ OFFSET CANCELADO COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesOffset('2');
            } else {
                mostrarStatusCancelamento('2',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhum offset estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('2',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar o offset:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar LINEARIZA√á√ÉO para MTX2
    async function cancelarLinearizacaoMtx2() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de LINEARIZA√á√ÉO do MTX2?')) {
            return;
        }

        mostrarStatusCancelamento('2', 'üîÑ Cancelando lineariza√ß√£o do MTX2...', 'warning');

        try {
            const response = await fetch('/cancelar-linearizacao-mtx2', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('2',
                    `‚úÖ LINEARIZA√á√ÉO CANCELADA COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesLinearizacao('2');
            } else {
                mostrarStatusCancelamento('2',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhuma lineariza√ß√£o estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('2',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar a lineariza√ß√£o:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar TUDO para MTX2
    async function cancelarTudoMtx2() {
        if (!confirm('üö® EMERG√äNCIA! \n\nDeseja CANCELAR TODOS os processos do MTX2?')) {
            return;
        }

        mostrarStatusCancelamento('2', 'üö® CANCELANDO TODOS OS PROCESSOS DO MTX2...', 'error');

        try {
            const promises = [
                fetch('/cancelar-offset-mtx2', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
                fetch('/cancelar-linearizacao-mtx2', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            ];

            const responses = await Promise.allSettled(promises);

            let mensagem = 'RESULTADOS DO CANCELAMENTO:\n\n';
            let sucessos = 0;

            responses.forEach((response, index) => {
                const tipo = index === 0 ? 'OFFSET' : 'LINEARIZA√á√ÉO';

                if (response.status === 'fulfilled' && response.value.ok) {
                    const resultado = response.value.json();
                    mensagem += `‚Ä¢ ${tipo}: ${resultado.mensagem}\n`;
                    if (resultado.cancelamento_efetivo) sucessos++;
                } else {
                    mensagem += `‚Ä¢ ${tipo}: Erro de conex√£o\n`;
                }
            });

            if (sucessos > 0) {
                mensagem = `‚úÖ ${sucessos} PROCESSO(S) CANCELADO(S)!\n\n` + mensagem;
                mostrarStatusCancelamento('2', mensagem, 'success');
            } else {
                mensagem = `‚ö†Ô∏è NENHUM PROCESSO CANCELADO\n\n` + mensagem;
                mostrarStatusCancelamento('2', mensagem, 'warning');
            }

            // Resetar bot√µes
            resetarBotoesOffset('2');
            resetarBotoesLinearizacao('2');
            resetarBotoesProcedimento('2');

        } catch (error) {
            mostrarStatusCancelamento('2',
                `‚ùå ERRO CR√çTICO!\n\nFalha ao tentar cancelar tudo:\n${error.message}`,
                'error'
            );
        }
    }

    // ============ MTX 3 ============

    // Cancelar OFFSET para MTX3
    async function cancelarOffsetMtx3() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de OFFSET do MTX3?')) {
            return;
        }

        mostrarStatusCancelamento('3', 'üîÑ Cancelando offset do MTX3...', 'warning');

        try {
            const response = await fetch('/cancelar-offset-mtx3', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('3',
                    `‚úÖ OFFSET CANCELADO COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesOffset('3');
            } else {
                mostrarStatusCancelamento('3',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhum offset estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('3',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar o offset:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar LINEARIZA√á√ÉO para MTX3
    async function cancelarLinearizacaoMtx3() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de LINEARIZA√á√ÉO do MTX3?')) {
            return;
        }

        mostrarStatusCancelamento('3', 'üîÑ Cancelando lineariza√ß√£o do MTX3...', 'warning');

        try {
            const response = await fetch('/cancelar-linearizacao-mtx3', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('3',
                    `‚úÖ LINEARIZA√á√ÉO CANCELADA COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesLinearizacao('3');
            } else {
                mostrarStatusCancelamento('3',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhuma lineariza√ß√£o estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('3',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar a lineariza√ß√£o:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar TUDO para MTX3
    async function cancelarTudoMtx3() {
        if (!confirm('üö® EMERG√äNCIA! \n\nDeseja CANCELAR TODOS os processos do MTX3?')) {
            return;
        }

        mostrarStatusCancelamento('3', 'üö® CANCELANDO TODOS OS PROCESSOS DO MTX3...', 'error');

        try {
            const promises = [
                fetch('/cancelar-offset-mtx3', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
                fetch('/cancelar-linearizacao-mtx3', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            ];

            const responses = await Promise.allSettled(promises);

            let mensagem = 'RESULTADOS DO CANCELAMENTO:\n\n';
            let sucessos = 0;

            responses.forEach((response, index) => {
                const tipo = index === 0 ? 'OFFSET' : 'LINEARIZA√á√ÉO';

                if (response.status === 'fulfilled' && response.value.ok) {
                    const resultado = response.value.json();
                    mensagem += `‚Ä¢ ${tipo}: ${resultado.mensagem}\n`;
                    if (resultado.cancelamento_efetivo) sucessos++;
                } else {
                    mensagem += `‚Ä¢ ${tipo}: Erro de conex√£o\n`;
                }
            });

            if (sucessos > 0) {
                mensagem = `‚úÖ ${sucessos} PROCESSO(S) CANCELADO(S)!\n\n` + mensagem;
                mostrarStatusCancelamento('3', mensagem, 'success');
            } else {
                mensagem = `‚ö†Ô∏è NENHUM PROCESSO CANCELADO\n\n` + mensagem;
                mostrarStatusCancelamento('3', mensagem, 'warning');
            }

            // Resetar bot√µes
            resetarBotoesOffset('3');
            resetarBotoesLinearizacao('3');
            resetarBotoesProcedimento('3');

        } catch (error) {
            mostrarStatusCancelamento('3',
                `‚ùå ERRO CR√çTICO!\n\nFalha ao tentar cancelar tudo:\n${error.message}`,
                'error'
            );
        }
    }

    // ============ MTX 4 ============

    // Cancelar OFFSET para MTX4
    async function cancelarOffsetMtx4() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de OFFSET do MTX4?')) {
            return;
        }

        mostrarStatusCancelamento('4', 'üîÑ Cancelando offset do MTX4...', 'warning');

        try {
            const response = await fetch('/cancelar-offset-mtx4', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('4',
                    `‚úÖ OFFSET CANCELADO COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesOffset('4');
            } else {
                mostrarStatusCancelamento('4',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhum offset estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('4',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar o offset:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar LINEARIZA√á√ÉO para MTX4
    async function cancelarLinearizacaoMtx4() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! \n\nDeseja CANCELAR o processo de LINEARIZA√á√ÉO do MTX4?')) {
            return;
        }

        mostrarStatusCancelamento('4', 'üîÑ Cancelando lineariza√ß√£o do MTX4...', 'warning');

        try {
            const response = await fetch('/cancelar-linearizacao-mtx4', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const resultado = await response.json();

            if (resultado.cancelamento_efetivo) {
                mostrarStatusCancelamento('4',
                    `‚úÖ LINEARIZA√á√ÉO CANCELADA COM SUCESSO!\n\nStatus: ${resultado.mensagem}`,
                    'success'
                );
                resetarBotoesLinearizacao('4');
            } else {
                mostrarStatusCancelamento('4',
                    `‚ö†Ô∏è ${resultado.mensagem}\n\nNenhuma lineariza√ß√£o estava em execu√ß√£o.`,
                    'warning'
                );
            }

        } catch (error) {
            mostrarStatusCancelamento('4',
                `‚ùå ERRO DE CONEX√ÉO!\n\nN√£o foi poss√≠vel cancelar a lineariza√ß√£o:\n${error.message}`,
                'error'
            );
        }
    }

    // Cancelar TUDO para MTX4
    async function cancelarTudoMtx4() {
        if (!confirm('üö® EMERG√äNCIA! \n\nDeseja CANCELAR TODOS os processos do MTX4?')) {
            return;
        }

        mostrarStatusCancelamento('4', 'üö® CANCELANDO TODOS OS PROCESSOS DO MTX4...', 'error');

        try {
            const promises = [
                fetch('/cancelar-offset-mtx4', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
                fetch('/cancelar-linearizacao-mtx4', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            ];

            const responses = await Promise.allSettled(promises);

            let mensagem = 'RESULTADOS DO CANCELAMENTO:\n\n';
            let sucessos = 0;

            responses.forEach((response, index) => {
                const tipo = index === 0 ? 'OFFSET' : 'LINEARIZA√á√ÉO';

                if (response.status === 'fulfilled' && response.value.ok) {
                    const resultado = response.value.json();
                    mensagem += `‚Ä¢ ${tipo}: ${resultado.mensagem}\n`;
                    if (resultado.cancelamento_efetivo) sucessos++;
                } else {
                    mensagem += `‚Ä¢ ${tipo}: Erro de conex√£o\n`;
                }
            });

            if (sucessos > 0) {
                mensagem = `‚úÖ ${sucessos} PROCESSO(S) CANCELADO(S)!\n\n` + mensagem;
                mostrarStatusCancelamento('4', mensagem, 'success');
            } else {
                mensagem = `‚ö†Ô∏è NENHUM PROCESSO CANCELADO\n\n` + mensagem;
                mostrarStatusCancelamento('4', mensagem, 'warning');
            }

            // Resetar bot√µes
            resetarBotoesOffset('4');
            resetarBotoesLinearizacao('4');
            resetarBotoesProcedimento('4');

        } catch (error) {
            mostrarStatusCancelamento('4',
                `‚ùå ERRO CR√çTICO!\n\nFalha ao tentar cancelar tudo:\n${error.message}`,
                'error'
            );
        }
    }

    // ============ FUN√á√ïES AUXILIARES ============

    // Fun√ß√£o para obter o canal atual do MTX
    function obterCanalAtual(mtx) {
        const canalBtn = document.getElementById(`canalBtn${mtx}`);
        if (!canalBtn) return '14'; // Valor padr√£o

        const texto = canalBtn.textContent;
        const match = texto.match(/Canal:\s*(\d+)/);
        return match ? match[1] : '14';
    }

    // Fun√ß√£o para obter a pot√™ncia atual do MTX
    function obterPotenciaAtual(mtx) {
        const potenciaBtn = document.getElementById(`potenciaBtn${mtx}`);
        if (!potenciaBtn) return '300'; // Valor padr√£o 1W

        const texto = potenciaBtn.textContent;
        const match = texto.match(/Pot√™ncia:\s*(\d+\.?\d*W)/);
        if (match) {
            const potenciaTexto = match[1];
            // Converte texto para valor DAC
            const potenciaMap = {
                '1W': '300',
                '2.5W': '340',
                '5W': '370',
                '20W': '430',
                '67.3W': '486'
            };
            return potenciaMap[potenciaTexto] || '300';
        }
        return '300';
    }

    // Fun√ß√£o para resetar bot√µes de offset
    function resetarBotoesOffset(mtx) {
        const iniciarBtn = document.getElementById(`comecarOffsetCanalBtn${mtx}`);
        const pararBtn = document.getElementById(`pararOffsetCanalBtn${mtx}`);

        if (iniciarBtn && pararBtn) {
            iniciarBtn.style.display = 'inline-block';
            pararBtn.style.display = 'none';
            pararBtn.classList.remove('ativo');
        }
    }

    // Fun√ß√£o para resetar bot√µes de lineariza√ß√£o
    function resetarBotoesLinearizacao(mtx) {
        const iniciarBtn = document.getElementById(`comecarLinearizacaoCanalBtn${mtx}`);
        const pararBtn = document.getElementById(`pararLinearizacaoCanalBtn${mtx}`);

        if (iniciarBtn && pararBtn) {
            iniciarBtn.style.display = 'inline-block';
            pararBtn.style.display = 'none';
            pararBtn.classList.remove('ativo');
        }
    }

    // Fun√ß√£o para resetar bot√µes de procedimento
    function resetarBotoesProcedimento(mtx) {
        const iniciarBtn = document.getElementById(`procedimentoCanalBtn${mtx}`);
        const pararBtn = document.getElementById(`cancelarProcedimentoCanalBtn${mtx}`);

        if (iniciarBtn && pararBtn) {
            iniciarBtn.style.display = 'inline-block';
            pararBtn.style.display = 'none';
            pararBtn.classList.remove('ativo');
        }
    }

    // Fun√ß√£o para resetar bot√µes de procedimento completo
    function resetarBotoesProcedimentoCompleto(mtx) {
        const iniciarBtn = document.getElementById(`procedimentoCompletoBtn${mtx}`);
        const pararBtn = document.getElementById(`cancelarProcedimentoCompletoBtn${mtx}`);

        if (iniciarBtn && pararBtn) {
            iniciarBtn.style.display = 'inline-block';
            pararBtn.style.display = 'none';
            pararBtn.classList.remove('ativo');
        }
    }

    // ============ FUN√á√ïES PARA LIGAR/DESLIGAR MTX ============

    // Mostrar status
    function mostrarMtxStatus(mtx, mensagem, tipo) {
        const statusDiv = document.getElementById(`mtxStatus${mtx}`);
        if (!statusDiv) return;

        statusDiv.textContent = mensagem;
        statusDiv.className = 'loop-status';

        if (tipo === 'success') {
            statusDiv.classList.add('status-success');
        } else if (tipo === 'error') {
            statusDiv.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusDiv.classList.add('status-loading');
        }

        statusDiv.style.display = 'block';

        // Esconde ap√≥s 3 segundos
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }

    // Fun√ß√£o para ligar MTX
    async function ligarMTX(mtx) {
        const ligarBtn = document.getElementById(`ligarBtn${mtx}`);
        const desligarBtn = document.getElementById(`desligarBtn${mtx}`);

        mostrarMtxStatus(mtx, 'Ligando MTX...', 'loading');

        try {
            // Determina qual endpoint chamar baseado no MTX
            let endpoint = '';
            switch(mtx) {
                case '1':
                    endpoint = `/ligarMtx1`;
                    break;
                case '2':
                    endpoint = `/ligarMtx2`;
                    break;
                case '3':
                    endpoint = `/ligarMtx3`;
                    break;
                case '4':
                    endpoint = `/ligarMtx4`;
                    break;
                default:
                    throw new Error('MTX inv√°lido');
            }

            const response = await fetch(endpoint, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                if (ligarBtn && desligarBtn) {
                    ligarBtn.style.display = 'none';
                    desligarBtn.style.display = 'inline-block';
                    desligarBtn.classList.add('ativo');
                }

                mostrarMtxStatus(mtx, 'MTX ligado!', 'success');

                setTimeout(() => {
                    carregarDados();
                }, 2000);

            } else {
                mostrarMtxStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarMtxStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro ao ligar MTX:', error);
        }
    }

    // Fun√ß√£o para desligar MTX
    async function desligarMTX(mtx) {
        const ligarBtn = document.getElementById(`ligarBtn${mtx}`);
        const desligarBtn = document.getElementById(`desligarBtn${mtx}`);

        mostrarMtxStatus(mtx, 'Desligando MTX...', 'loading');

        try {
            // Determina qual endpoint chamar baseado no MTX
            let endpoint = '';
            switch(mtx) {
                case '1':
                    endpoint = `/desligarMtx1`;
                    break;
                case '2':
                    endpoint = `/desligarMtx2`;
                    break;
                case '3':
                    endpoint = `/desligarMtx3`;
                    break;
                case '4':
                    endpoint = `/desligarMtx4`;
                    break;
                default:
                    throw new Error('MTX inv√°lido');
            }

            const response = await fetch(endpoint, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                if (ligarBtn && desligarBtn) {
                    ligarBtn.style.display = 'inline-block';
                    desligarBtn.style.display = 'none';
                    desligarBtn.classList.remove('ativo');
                }

                mostrarMtxStatus(mtx, 'MTX desligado!', 'success');

                setTimeout(() => {
                    carregarDados();
                }, 2000);

            } else {
                mostrarMtxStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarMtxStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro ao desligar MTX:', error);
        }
    }

    // ============ FUN√á√ïES PARA PROCEDIMENTO COMPLETO (3 CANAIS) ============

    // Fun√ß√£o para iniciar procedimento completo (14 ‚Üí 34 ‚Üí 51)
    async function iniciarProcedimentoCompleto(mtx) {
        mostrarProcedimentoCompletoStatus(mtx, 'Iniciando rotina principal completa...', 'loading');

        try {
            // Mostra bot√µes
            const iniciarBtn = document.getElementById(`procedimentoCompletoBtn${mtx}`);
            const cancelarBtn = document.getElementById(`cancelarProcedimentoCompletoBtn${mtx}`);

            if (iniciarBtn && cancelarBtn) {
                iniciarBtn.style.display = 'none';
                cancelarBtn.style.display = 'inline-block';
                cancelarBtn.classList.add('ativo');
            }

            // Chama endpoint do procedimento completo (ajuste offset + lineariza√ß√£o + checagem para 3 canais)
            const response = await fetch(`/executar-procedimento-completo-mtx${mtx}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarProcedimentoCompletoStatus(mtx,
                    `<strong>ROTINA PRINCIPAL INICIADA!</strong><br>` +
                    `Sequ√™ncia: 14 ‚Üí 34 ‚Üí 51<br>` +
                    `Hora in√≠cio: ${resultado.hora_inicio || new Date().toLocaleString()}<br>` +
                    `Status: ${resultado.mensagem}<br><br>` +
                    `<small>Monitorando progresso...</small>`,
                    'success'
                );

                // INICIA MONITORAMENTO ESPEC√çFICO
                iniciarMonitoramentoProcedimentoCompleto(mtx);

                // Atualiza dados periodicamente
                const atualizarInterval = setInterval(() => {
                    carregarDados();
                }, 30000); // Atualiza a cada 30 segundos

                // Fallback: para ap√≥s 3 horas (seguran√ßa)
                setTimeout(() => {
                    clearInterval(atualizarInterval);
                    if (document.getElementById(`procedimentoCompletoBtn${mtx}`).style.display === 'none') {
                        finalizarProcedimentoCompleto(mtx);
                    }
                }, 10800000);

            } else {
                mostrarProcedimentoCompletoStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
                resetarBotoesProcedimentoCompleto(mtx);
            }

        } catch (error) {
            mostrarProcedimentoCompletoStatus(mtx, 'Erro de conex√£o com o servidor', 'error');
            console.error('Erro ao iniciar procedimento completo:', error);
            resetarBotoesProcedimentoCompleto(mtx);
        }
    }

    // Fun√ß√£o para cancelar procedimento completo
    async function cancelarProcedimentoCompleto(mtx) {
        if (!confirm('Tem certeza que deseja cancelar a rotina principal completa?')) {
            return;
        }

        mostrarProcedimentoCompletoStatus(mtx, 'Cancelando rotina principal...', 'loading');

        try {
            const response = await fetch(`/cancelar-procedimento-mtx${mtx}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarProcedimentoCompletoStatus(mtx, 'Rotina principal cancelada!', 'success');
            } else {
                mostrarProcedimentoCompletoStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarProcedimentoCompletoStatus(mtx, 'Erro de conex√£o ao cancelar', 'error');
            console.error('Erro ao cancelar procedimento completo:', error);
        } finally {
            resetarBotoesProcedimentoCompleto(mtx);
        }
    }

    // Fun√ß√£o para monitorar o progresso do procedimento completo
    async function iniciarMonitoramentoProcedimentoCompleto(mtx) {
        const statusElement = document.getElementById(`procedimentoTodosStatus${mtx}`);

        // Fun√ß√£o de atualiza√ß√£o de status
        const atualizarStatus = async () => {
            try {
                const response = await fetch(`/status-procedimento-mtx${mtx}`);
                if (!response.ok) return;

                const status = await response.json();

                if (status.ativo) {
                    let mensagem = `<strong>ROTINA PRINCIPAL EM ANDAMENTO</strong><br>`;
                    mensagem += `Status: ${status.status || 'executando'}<br>`;
                    mensagem += `Canal atual: ${status.canal || 'N/A'}<br>`;
                    mensagem += `Etapa: ${status.etapa || 'N/A'}<br>`;
                    mensagem += `In√≠cio: ${status.hora_inicio || 'N/A'}<br>`;
                    mensagem += `√öltima atualiza√ß√£o: ${status.ultima_atualizacao || 'N/A'}`;

                    if (statusElement) {
                        statusElement.innerHTML = mensagem;
                        statusElement.className = 'loop-status status-warning';
                        statusElement.style.display = 'block';
                    }
                } else {
                    // Procedimento terminou
                    finalizarProcedimentoCompleto(mtx);
                }
            } catch (error) {
                console.error('Erro ao monitorar procedimento:', error);
            }
        };

        // Atualiza a cada 10 segundos
        const monitorInterval = setInterval(atualizarStatus, 10000);

        // Primeira atualiza√ß√£o
        atualizarStatus();

        // Guarda o intervalo para limpar depois
        window[`procedimentoCompletoMonitor${mtx}`] = monitorInterval;
    }

    // Fun√ß√£o para finalizar procedimento completo
    function finalizarProcedimentoCompleto(mtx) {
        // Limpa o monitoramento
        if (window[`procedimentoCompletoMonitor${mtx}`]) {
            clearInterval(window[`procedimentoCompletoMonitor${mtx}`]);
            delete window[`procedimentoCompletoMonitor${mtx}`];
        }

        // Mostra mensagem de conclus√£o
        const statusElement = document.getElementById(`procedimentoTodosStatus${mtx}`);
        if (statusElement) {
            statusElement.innerHTML = `<strong>ROTINA PRINCIPAL CONCLU√çDA!</strong><br>Procedimento completo finalizado para todos os canais.`;
            statusElement.className = 'loop-status status-success';
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 10000);
        }

        // Resetar bot√µes
        resetarBotoesProcedimentoCompleto(mtx);

        // For√ßar atualiza√ß√£o de dados
        setTimeout(() => {
            carregarDados();
        }, 3000);
    }

    // Fun√ß√£o para mostrar status do procedimento completo
    function mostrarProcedimentoCompletoStatus(mtx, mensagem, tipo) {
        const statusElement = document.getElementById(`procedimentoTodosStatus${mtx}`);

        if (!statusElement) {
            console.error(`Elemento procedimentoTodosStatus${mtx} n√£o encontrado`);
            return;
        }

        statusElement.innerHTML = mensagem;
        statusElement.className = `loop-status`;

        if (tipo === 'success') {
            statusElement.classList.add('status-success');
        } else if (tipo === 'error') {
            statusElement.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusElement.classList.add('status-loading');
        } else if (tipo === 'warning') {
            statusElement.classList.add('status-warning');
        }

        statusElement.style.display = 'block';

        // Se for erro, adicionar bot√£o de tentar novamente
        if (tipo === 'error') {
            const tentarNovamenteBtn = document.createElement('button');
            tentarNovamenteBtn.textContent = 'Tentar novamente';
            tentarNovamenteBtn.className = 'tentar-novamente-btn';
            tentarNovamenteBtn.onclick = () => iniciarProcedimentoCompleto(mtx);
            statusElement.appendChild(document.createElement('br'));
            statusElement.appendChild(tentarNovamenteBtn);
        }

        // N√£o esconde automaticamente quando √© warning (monitoramento ativo)
        if (tipo !== 'warning' && tipo !== 'loading') {
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 10000);
        }
    }

    // ============ FUN√á√ïES PARA PROCEDIMENTO PARA CANAL ATUAL ============

    // Fun√ß√£o para iniciar procedimento para canal ATUAL
    async function iniciarProcedimentoCanalAtual(mtx) {
        const canal = obterCanalAtual(mtx);

        mostrarProcedimentoStatus(mtx, `Iniciando procedimento completo para canal ${canal}...`, 'loading');

        try {
            // Mostra bot√µes
            const iniciarBtn = document.getElementById(`procedimentoCanalBtn${mtx}`);
            const cancelarBtn = document.getElementById(`cancelarProcedimentoCanalBtn${mtx}`);

            if (iniciarBtn && cancelarBtn) {
                iniciarBtn.style.display = 'none';
                cancelarBtn.style.display = 'inline-block';
                cancelarBtn.classList.add('ativo');
            }

            // Chama endpoint com canal espec√≠fico
            const response = await fetch(`/executar-procedimento-canal-mtx${mtx}?canal=${canal}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarProcedimentoStatus(mtx,
                    `<strong>PROCEDIMENTO INICIADO!</strong><br>` +
                    `Canal: ${canal}<br>` +
                    `Status: ${resultado.mensagem}`,
                    'success'
                );

                // Atualiza dados ap√≥s procedimento
                setTimeout(() => {
                    carregarDados();
                }, 5000);

            } else {
                mostrarProcedimentoStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
                resetarBotoesProcedimento(mtx);
            }

        } catch (error) {
            mostrarProcedimentoStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro ao iniciar procedimento:', error);
            resetarBotoesProcedimento(mtx);
        }
    }

    // Fun√ß√£o para cancelar procedimento de canal ATUAL
    async function cancelarProcedimentoCanalAtual(mtx) {
        mostrarProcedimentoStatus(mtx, 'Cancelando procedimento...', 'loading');

        try {
            const response = await fetch(`/cancelar-procedimento-mtx${mtx}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarProcedimentoStatus(mtx, 'Procedimento cancelado!', 'success');
            } else {
                mostrarProcedimentoStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarProcedimentoStatus(mtx, 'Erro de conex√£o', 'error');
        } finally {
            resetarBotoesProcedimento(mtx);
        }
    }

    // Fun√ß√£o para mostrar status do procedimento
    function mostrarProcedimentoStatus(mtx, mensagem, tipo) {
        const statusElement = document.getElementById(`procedimentoStatus${mtx}`);

        if (!statusElement) {
            console.error(`Elemento procedimentoStatus${mtx} n√£o encontrado`);
            return;
        }

        statusElement.innerHTML = mensagem;
        statusElement.className = `loop-status`;

        if (tipo === 'success') {
            statusElement.classList.add('status-success');
        } else if (tipo === 'error') {
            statusElement.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusElement.classList.add('status-loading');
        }

        statusElement.style.display = 'block';

        // Se for erro, adicionar bot√£o de tentar novamente
        if (tipo === 'error') {
            const tentarNovamenteBtn = document.createElement('button');
            tentarNovamenteBtn.textContent = 'Tentar novamente';
            tentarNovamenteBtn.className = 'tentar-novamente-btn';
            tentarNovamenteBtn.onclick = () => iniciarProcedimentoCanalAtual(mtx);
            statusElement.appendChild(document.createElement('br'));
            statusElement.appendChild(tentarNovamenteBtn);
        }

        // Esconde ap√≥s 10 segundos (se n√£o for erro)
        if (tipo !== 'error') {
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 10000);
        }
    }

    // ============ FUN√á√ïES PARA APLICAR OFFSET ============

    // Fun√ß√£o para aplicar offset em MTX espec√≠fico
    async function aplicarOffsetMTX(mtx) {
        const inputElement = document.getElementById(`offsetInicialMtx${mtx}`);
        const btnElement = document.getElementById(`btnAplicarOffsetMTX${mtx}`);
        const statusElement = document.getElementById(`offsetStatusMtx${mtx}`);

        if (!inputElement || !btnElement || !statusElement) {
            console.error(`Elementos n√£o encontrados para MTX${mtx}`);
            return;
        }

        const valorOffset = inputElement.value.trim();

        if (!valorOffset) {
            statusElement.textContent = "Digite um valor para o offset!";
            statusElement.style.color = "#f00";
            return;
        }

        // Validar valor
        const offsetNum = parseInt(valorOffset);
        if (isNaN(offsetNum) || offsetNum < -32768 || offsetNum > 32767) {
            statusElement.textContent = "Valor inv√°lido! Use n√∫meros entre -32768 e 32767";
            statusElement.style.color = "#f00";
            return;
        }

        // Desabilitar bot√£o e mostrar carregamento
        btnElement.disabled = true;
        btnElement.textContent = "Aplicando...";
        btnElement.classList.add('loading');

        statusElement.textContent = "Aplicando offset...";
        statusElement.style.color = "#ff9900";

        try {
            // Usar o endpoint correto baseado no MTX
            let endpoint;
            switch(mtx) {
                case '1':
                    endpoint = '/configurar-offset-mtx1';
                    break;
                case '2':
                    endpoint = '/configurar-offset-mtx2';
                    break;
                case '3':
                    endpoint = '/configurar-offset-mtx3';
                    break;
                case '4':
                    endpoint = '/configurar-offset-mtx4';
                    break;
                default:
                    throw new Error('MTX inv√°lido');
            }

            const response = await fetch(`${endpoint}?offset=${valorOffset}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                statusElement.textContent = `${resultado.mensagem}`;
                statusElement.style.color = "#0f0";

                // Atualiza o display do offset na interface
                const offsetDisplay = document.getElementById(`offSetMtx${mtx}`);
                if (offsetDisplay) {
                    offsetDisplay.textContent = valorOffset;
                    offsetDisplay.style.color = "#0f0";
                }

                // Mostrar mensagem de sucesso tempor√°ria
                mostrarMtxStatus(mtx, `Offset ${valorOffset} aplicado com sucesso!`, 'success');

            } else {
                statusElement.textContent = `${resultado.mensagem || "Erro ao aplicar offset"}`;
                statusElement.style.color = "#f00";
                mostrarMtxStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            statusElement.textContent = "Erro de conex√£o: " + error.message;
            statusElement.style.color = "#f00";
            console.error('Erro ao aplicar offset:', error);
            mostrarMtxStatus(mtx, "Erro de conex√£o ao aplicar offset", 'error');

        } finally {
            // Restaurar bot√£o ap√≥s 2 segundos
            setTimeout(() => {
                btnElement.disabled = false;
                btnElement.textContent = "Aplicar Offset";
                btnElement.classList.remove('loading');
            }, 2000);

            // Atualizar dados da interface ap√≥s 3 segundos
            setTimeout(() => {
                carregarDados();
            }, 3000);
        }
    }

    // Fun√ß√£o para aplicar offset em todos os MTXs
    async function aplicarOffsetTodosMTXs() {
        const valorOffset = prompt("Digite o valor do offset para aplicar em TODOS os MTXs:");

        if (!valorOffset) {
            mostrarStatusGeral("Opera√ß√£o cancelada", "warning");
            return;
        }

        const offsetNum = parseInt(valorOffset);
        if (isNaN(offsetNum) || offsetNum < -32768 || offsetNum > 32767) {
            mostrarStatusGeral("Valor inv√°lido! Use n√∫meros entre -32768 e 32767", "error");
            return;
        }

        mostrarStatusGeral(`Aplicando offset ${valorOffset} em todos MTXs...`, 'loading');

        try {
            // Para MTX1
            await fetch(`/configurar-offset-mtx1?offset=${valorOffset}`, { method: 'POST' });

            // Para MTX2 (se existir)
            try {
                await fetch(`/configurar-offset-mtx2?offset=${valorOffset}`, { method: 'POST' });
            } catch (e) {
                console.warn('MTX2 n√£o dispon√≠vel:', e);
            }

            // Para MTX3 (se existir)
            try {
                await fetch(`/configurar-offset-mtx3?offset=${valorOffset}`, { method: 'POST' });
            } catch (e) {
                console.warn('MTX3 n√£o dispon√≠vel:', e);
            }

            // Para MTX4 (se existir)
            try {
                await fetch(`/configurar-offset-mtx4?offset=${valorOffset}`, { method: 'POST' });
            } catch (e) {
                console.warn('MTX4 n√£o dispon√≠vel:', e);
            }

            mostrarStatusGeral(
                `<strong>OFFSET APLICADO COM SUCESSO!</strong><br>` +
                `Valor: ${valorOffset}<br>` +
                `Todos os MTXs foram atualizados.`,
                'success'
            );

            // Atualizar displays de offset
            for (let i = 1; i <= 4; i++) {
                const offsetDisplay = document.getElementById(`offSetMtx${i}`);
                if (offsetDisplay) {
                    offsetDisplay.textContent = valorOffset;
                    offsetDisplay.style.color = "#0f0";
                }
            }

        } catch (error) {
            mostrarStatusGeral("Erro ao aplicar offset em todos MTXs: " + error.message, 'error');
            console.error('Erro ao aplicar offset em todos:', error);

        } finally {
            // Atualizar dados da interface
            setTimeout(() => {
                carregarDados();
            }, 5000);
        }
    }

    // ============ FUN√á√ïES PARA OFFSET CANAL ATUAL ============

    // Fun√ß√£o para iniciar offset para canal atual
    async function iniciarOffsetCanalAtual(mtx) {
        const canal = obterCanalAtual(mtx);
        const potenciaDAC = obterPotenciaAtual(mtx);

        mostrarMtxStatus(mtx, `Iniciando offset para canal ${canal}...`, 'loading');

        try {
            // Mostra bot√µes
            const iniciarBtn = document.getElementById(`comecarOffsetCanalBtn${mtx}`);
            const pararBtn = document.getElementById(`pararOffsetCanalBtn${mtx}`);

            if (iniciarBtn && pararBtn) {
                iniciarBtn.style.display = 'none';
                pararBtn.style.display = 'inline-block';
                pararBtn.classList.add('ativo');
            }

            // Chama endpoint com canal e pot√™ncia espec√≠ficos
            const response = await fetch(`/executar-offset-canal-mtx${mtx}?canal=${canal}&potencia=${potenciaDAC}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarMtxStatus(mtx,
                    `<strong>OFFSET INICIADO!</strong><br>` +
                    `Canal: ${canal}<br>` +
                    `Pot√™ncia: ${resultado.potencia || 'N/A'}W<br>` +
                    `Status: ${resultado.mensagem}`,
                    'success'
                );

                setTimeout(() => {
                    carregarDados();
                }, 3000);

            } else {
                mostrarMtxStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
                resetarBotoesOffset(mtx);
            }

        } catch (error) {
            mostrarMtxStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro ao iniciar offset:', error);
            resetarBotoesOffset(mtx);
        }
    }

    // Fun√ß√£o para finalizar offset para canal atual
    async function finalizarOffsetCanalAtual(mtx) {
        mostrarMtxStatus(mtx, 'Finalizando offset...', 'loading');

        try {
            const response = await fetch(`/cancelar-offset-mtx${mtx}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarMtxStatus(mtx, 'Offset finalizado!', 'success');
            } else {
                mostrarMtxStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarMtxStatus(mtx, 'Erro de conex√£o', 'error');
        } finally {
            resetarBotoesOffset(mtx);
        }
    }

    // ============ FUN√á√ïES PARA LINEARIZA√á√ÉO ============

    // Fun√ß√£o para iniciar lineariza√ß√£o para canal atual
    async function iniciarLinearizacaoCanalAtual(mtx) {
        const canal = obterCanalAtual(mtx);

        mostrarMtxStatusLinearizacao(mtx, `Iniciando lineariza√ß√£o para canal ${canal}...`, 'loading');

        try {
            // Mostra bot√µes
            const iniciarBtn = document.getElementById(`comecarLinearizacaoCanalBtn${mtx}`);
            const pararBtn = document.getElementById(`pararLinearizacaoCanalBtn${mtx}`);

            if (iniciarBtn && pararBtn) {
                iniciarBtn.style.display = 'none';
                pararBtn.style.display = 'inline-block';
                pararBtn.classList.add('ativo');
            }

            // Chama endpoint com canal espec√≠fico
            const response = await fetch(`/executar-linearizacao-canal-mtx${mtx}?canal=${canal}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarMtxStatusLinearizacao(mtx,
                    `<strong>LINEARIZA√á√ÉO INICIADA!</strong><br>` +
                    `Canal: ${canal}<br>` +
                    `Status: ${resultado.mensagem}<br>` +
                    `Tempo estimado: ${resultado.tempo_estimado || 'N/A'}`,
                    'success'
                );

                setTimeout(() => {
                    carregarDados();
                }, 4000);

            } else {
                mostrarMtxStatusLinearizacao(mtx, `Erro: ${resultado.mensagem}`, 'error');
                resetarBotoesLinearizacao(mtx);
            }

        } catch (error) {
            mostrarMtxStatusLinearizacao(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro ao iniciar lineariza√ß√£o:', error);
            resetarBotoesLinearizacao(mtx);
        }
    }

    // Fun√ß√£o para finalizar lineariza√ß√£o para canal atual
    async function finalizarLinearizacaoCanalAtual(mtx) {
        mostrarMtxStatusLinearizacao(mtx, 'Finalizando lineariza√ß√£o...', 'loading');

        try {
            const response = await fetch(`/cancelar-linearizacao-mtx${mtx}`, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                mostrarMtxStatusLinearizacao(mtx, 'Lineariza√ß√£o finalizada!', 'success');
            } else {
                mostrarMtxStatusLinearizacao(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarMtxStatusLinearizacao(mtx, 'Erro de conex√£o', 'error');
        } finally {
            resetarBotoesLinearizacao(mtx);
        }
    }

    // Fun√ß√£o auxiliar para mostrar status de lineariza√ß√£o
    function mostrarMtxStatusLinearizacao(mtx, mensagem, tipo) {
        const statusElement = document.getElementById(`loopLinearizacao${mtx}`);

        if (!statusElement) {
            console.error(`Elemento loopLinearizacao${mtx} n√£o encontrado`);
           return;
        }

        statusElement.innerHTML = mensagem;
        statusElement.className = `loop-status`;

        if (tipo === 'success') {
            statusElement.classList.add('status-success');
        } else if (tipo === 'error') {
            statusElement.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusElement.classList.add('status-loading');
        }

        statusElement.style.display = 'block';

        // Se for erro, adicionar bot√£o de tentar novamente
        if (tipo === 'error') {
            const tentarNovamenteBtn = document.createElement('button');
            tentarNovamenteBtn.textContent = 'Tentar novamente';
            tentarNovamenteBtn.className = 'tentar-novamente-btn';
            tentarNovamenteBtn.onclick = () => iniciarLinearizacaoCanalAtual(mtx);
            statusElement.appendChild(document.createElement('br'));
            statusElement.appendChild(tentarNovamenteBtn);
        }

        // Esconde ap√≥s 10 segundos (se n√£o for erro)
        if (tipo !== 'error') {
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 10000);
        }
    }

    // ============ FUN√á√ïES DE MONITORAMENTO DE STATUS ============

    // Verifica o status de uma rotina espec√≠fica
    async function verificarStatusRotina(mtx, tipoRotina) {
        try {
            let endpoint = '';

            switch(tipoRotina) {
                case 'procedimento':
                    endpoint = `/status-procedimento-mtx${mtx}`;
                    break;
                case 'offset':
                    endpoint = `/status-offset-mtx${mtx}`;
                    break;
                case 'linearizacao':
                    endpoint = `/status-linearizacao-mtx${mtx}`;
                    break;
                default:
                    return false;
            }

            const response = await fetch(endpoint);
            if (!response.ok) return false;

            const resultado = await response.json();
            return resultado.status === 'executando';

        } catch (error) {
            console.error(`Erro ao verificar status MTX${mtx}:`, error);
            return false;
        }
    }

    // ============ FUN√á√ïES PARA DROPDOWNS ============
    function toggleDropdown(tipo) {
        // Encontra o dropdown espec√≠fico
        const dropdown = document.getElementById(`dropdown${tipo}`);

        // Verifica se o dropdown j√° est√° aberto
        const isOpen = dropdown.classList.contains('show');

        // Fecha todos os dropdowns primeiro
        document.querySelectorAll('.dropdown-content').forEach(d => {
            d.classList.remove('show');
        });

        // Se n√£o estava aberto, abre este
        if (!isOpen) {
            dropdown.classList.add('show');
        }
    }

    // Fechar dropdowns ao clicar fora
    document.addEventListener('click', function(event) {
        const isDropdownBtn = event.target.classList.contains('dropdown-btn');
        const isDropdownItem = event.target.classList.contains('dropdown-item');

        if (!isDropdownBtn && !isDropdownItem) {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });

    async function setarPotenciaDropdown(mtx, valorDAC, label) {
        // Mostra mensagem de carregamento
        mostrarPotenciaStatus(mtx, 'Aplicando...', 'loading');

        try {
            // Determina qual endpoint chamar baseado no MTX
            let endpoint = '';
            switch(mtx) {
                case '1':
                    endpoint = `/mudar-potencia-mtx1?valorPotencia=${valorDAC}`;
                    break;
                case '2':
                    endpoint = `/mudar-potencia-mtx2?valorPotencia=${valorDAC}`;
                    break;
                case '3':
                    endpoint = `/mudar-potencia-mtx3?valorPotencia=${valorDAC}`;
                    break;
                case '4':
                    endpoint = `/mudar-potencia-mtx4?valorPotencia=${valorDAC}`;
                    break;
                default:
                    throw new Error('MTX inv√°lido');
            }

            const response = await fetch(endpoint, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                // Atualiza o bot√£o do dropdown
                document.getElementById(`potenciaBtn${mtx}`).textContent = `Pot√™ncia: ${label}`;
                mostrarPotenciaStatus(mtx, `${label} aplicado!`, 'success');

                // Fecha o dropdown
                document.getElementById(`dropdownPotencia${mtx}`).classList.remove('show');

                // Recarrega dados ap√≥s 2 segundos
                setTimeout(() => {
                    carregarDados();
                }, 2000);

            } else {
                mostrarPotenciaStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarPotenciaStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro:', error);
        }
    }

    async function setarCanalDropdown(mtx, canal, label) {
        // Mostra mensagem de carregamento
        mostrarCanalStatus(mtx, 'Aplicando...', 'loading');

        try {
            // Determina qual endpoint chamar baseado no MTX
            let endpoint = '';
            switch(mtx) {
                case '1':
                    endpoint = `/mudar-canal-mtx1?valorCanal=${canal}`;
                    break;
                case '2':
                    endpoint = `/mudar-canal-mtx2?valorCanal=${canal}`;
                    break;
                case '3':
                    endpoint = `/mudar-canal-mtx3?valorCanal=${canal}`;
                    break;
                case '4':
                    endpoint = `/mudar-canal-mtx4?valorCanal=${canal}`;
                    break;
                default:
                    throw new Error('MTX inv√°lido');
            }

            const response = await fetch(endpoint, {
                method: 'POST'
            });

            const resultado = await response.json();

            if (response.ok && resultado.status === 'sucesso') {
                // Atualiza o bot√£o do dropdown
                document.getElementById(`canalBtn${mtx}`).textContent = `Canal: ${label}`;
                mostrarCanalStatus(mtx, `${label} aplicado!`, 'success');

                // Fecha o dropdown
                document.getElementById(`dropdownCanal${mtx}`).classList.remove('show');

                // Recarrega dados ap√≥s 2 segundos
                setTimeout(() => {
                    carregarDados();
                }, 2000);

            } else {
                mostrarCanalStatus(mtx, `Erro: ${resultado.mensagem}`, 'error');
            }

        } catch (error) {
            mostrarCanalStatus(mtx, 'Erro de conex√£o', 'error');
            console.error('Erro:', error);
        }
    }

    function mostrarPotenciaStatus(mtx, mensagem, tipo) {
        const statusDiv = document.getElementById(`potenciaStatus${mtx}`);
        statusDiv.textContent = mensagem;
        statusDiv.className = 'potencia-status';

        if (tipo === 'success') {
            statusDiv.classList.add('status-success');
        } else if (tipo === 'error') {
            statusDiv.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusDiv.classList.add('status-loading');
        }

        statusDiv.style.display = 'block';

        // Esconde ap√≥s 3 segundos
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }

    function mostrarCanalStatus(mtx, mensagem, tipo) {
        const statusDiv = document.getElementById(`canalStatus${mtx}`);
        statusDiv.textContent = mensagem;
        statusDiv.className = 'canal-status';

        if (tipo === 'success') {
            statusDiv.classList.add('status-success');
        } else if (tipo === 'error') {
            statusDiv.classList.add('status-error');
        } else if (tipo === 'loading') {
            statusDiv.classList.add('status-loading');
        }

        statusDiv.style.display = 'block';

        // Esconde ap√≥s 3 segundos
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }

    // ============ FUN√á√ïES DE ATUALIZA√á√ÉO ============
    const intervalosTextos = {
        30000: "30s",
        60000: "1min",
        180000: "3min",
        300000: "5min",
        600000: "10min",
        900000: "15min",
        1800000: "30min",
        3600000: "1h",
        21600000: "6h",
        43200000: "12h",
        'disabled': 'Disabled'
    };

    function removerSelecoes() {
        const itens = document.querySelectorAll('.dropdown-item');
        itens.forEach(item => {
            item.classList.remove('selected');
        });
    }

    async function setIntervalo(ms) {
        try {
            const response = await fetch(`/configurar-intervalo?milissegundos=${ms}`, {
                method: 'POST'
            });

            if (response.ok) {
                intervaloAtual = ms;
                atualizacaoAtiva = true;

                const texto = intervalosTextos[ms];
                document.querySelector('.dropdown-btn').textContent = `Atualizar: ${texto}`;

                removerSelecoes();
                event.target.classList.add('selected');

                // Fecha o dropdown
                document.getElementById('dropdownAtualizar').classList.remove('show');

                reiniciarTimerAtualizacao();

                await fetch('/toggle-agendamento?ativo=true', { method: 'POST' });
                atualizarStatus(`Atualiza√ß√£o: ${texto}`);
                carregarDados();
            }
        } catch (error) {
            console.error('Erro:', error);
            atualizarStatus('Erro ao configurar');
        }
    }

    async function desativarAtualizacao() {
        try {
            await fetch('/toggle-agendamento?ativo=false', {
                method: 'POST'
            });

            atualizacaoAtiva = false;
            document.querySelector('.dropdown-btn').textContent = 'Atualizar: Disabled';

            removerSelecoes();
            event.target.classList.add('selected');

            // Fecha o dropdown
            document.getElementById('dropdownAtualizar').classList.remove('show');

            if (timerAtualizacao) {
                clearInterval(timerAtualizacao);
                timerAtualizacao = null;
            }

            atualizarStatus('Atualiza√ß√£o autom√°tica desativada');
        } catch (error) {
            console.error('Erro:', error);
            atualizarStatus('Erro ao desativar');
        }
    }

    function reiniciarTimerAtualizacao() {
        if (timerAtualizacao) {
            clearInterval(timerAtualizacao);
        }

        if (atualizacaoAtiva) {
            timerAtualizacao = setInterval(carregarDados, intervaloAtual);
        }
    }

    function atualizarStatus(mensagem) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = mensagem;
        statusDiv.style.color = '#f00';

        setTimeout(() => {
            if (!mensagem.includes('desativada')) {
                statusDiv.textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
                statusDiv.style.color = '#0f0';
            }
        }, 3000);
    }

    async function carregarDados() {
        if (!atualizacaoAtiva) {
            return;
        }

        // ============ FUN√á√ÉO PRINCIPAL ============
        const statusDiv = document.getElementById('status');

        try {
            const response = await fetch('http://localhost:8087/dados.txt');

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const content = await response.text();
            const lines = content.split('\n');
            const data = {};

            lines.forEach(line => {
                const trimmed = line.trim();

                const extrairNumero = (texto) => {
                    if (!texto) return 'N/A';
                    const match = texto.match(/=\s*([\d.-]+)/);
                    return match ? match[1] : 'N/A';
                };

                // MTX 1
                if (trimmed.startsWith('chanel number1:')) data.chanelNumber1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('frequency1:')) data.frequency1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('forwardDBM1:')) data.forwardDBM1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Status ALC1:')) data.statusAlc1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Output DAC1:')) data.valorOutputDac1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Desired DAC1:')) data.valorDesiredDac1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Direta1:')) data.potencia1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Refletida1:')) data.refletida1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Temperatura1')) data.temperatura1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN1 MTX1')) data.fan1MTX1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN2 MTX1')) data.fan2MTX1 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('offSetMtx1')) data.offSetMtx1 = extrairNumero(trimmed.split(':')[1]);

                // MTX 2
                else if (trimmed.startsWith('chanel number2:')) data.chanelNumber2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('frequency2:')) data.frequency2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('forwardDBM2:')) data.forwardDBM2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Status ALC2:')) data.statusAlc2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Output DAC2:')) data.valorOutputDac2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Desired DAC2:')) data.valorDesiredDac2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Direta2:')) data.potencia2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Refletida2:')) data.refletida2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Temperatura2')) data.temperatura2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN1 MTX2')) data.fan1MTX2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN2 MTX2')) data.fan2MTX2 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('offSetMtx2')) data.offSetMtx2 = extrairNumero(trimmed.split(':')[1]);

                // MTX 3
                else if (trimmed.startsWith('chanel number3:')) data.chanelNumber3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('frequency3:')) data.frequency3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('forwardDBM3:')) data.forwardDBM3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Status ALC3:')) data.statusAlc3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Output DAC3:')) data.valorOutputDac3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Desired DAC3:')) data.valorDesiredDac3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Direta3:')) data.potencia3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Refletida3:')) data.refletida3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Temperatura3')) data.temperatura3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN1 MTX3')) data.fan1MTX3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN2 MTX3')) data.fan2MTX3 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('offSetMtx3')) data.offSetMtx3 = extrairNumero(trimmed.split(':')[1]);

                // MTX 4
                else if (trimmed.startsWith('chanel number4:')) data.chanelNumber4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('frequency4:')) data.frequency4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('forwardDBM4:')) data.forwardDBM4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Status ALC4:')) data.statusAlc4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Output DAC4:')) data.valorOutputDac4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Desired DAC4:')) data.valorDesiredDac4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Direta4:')) data.potencia4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Potencia Refletida4:')) data.refletida4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('Temperatura4')) data.temperatura4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN1 MTX4')) data.fan1MTX4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('FAN2 MTX4')) data.fan2MTX4 = extrairNumero(trimmed.split(':')[1]);
                else if (trimmed.startsWith('offSetMtx4')) data.offSetMtx4 = extrairNumero(trimmed.split(':')[1]);
            });

            // Preenche os campos para todos os MTXs
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`chanelNumber${i}`).textContent = data[`chanelNumber${i}`] || 'N/A';
                document.getElementById(`frequency${i}`).textContent = data[`frequency${i}`] || 'N/A';
                document.getElementById(`forwardDBM${i}`).textContent = data[`forwardDBM${i}`] || 'N/A';
                document.getElementById(`statusAlc${i}`).textContent = data[`statusAlc${i}`] || 'N/A';
                document.getElementById(`valorOutputDac${i}`).textContent = data[`valorOutputDac${i}`] || 'N/A';
                document.getElementById(`valorDesiredDac${i}`).textContent = data[`valorDesiredDac${i}`] || 'N/A';
                document.getElementById(`potencia${i}`).textContent = data[`potencia${i}`] || 'N/A';
                document.getElementById(`refletida${i}`).textContent = data[`refletida${i}`] || 'N/A';
                document.getElementById(`temperatura${i}`).textContent = data[`temperatura${i}`] || 'N/A';
                document.getElementById(`fan1MTX${i}`).textContent = data[`fan1MTX${i}`] || 'N/A';
                document.getElementById(`fan2MTX${i}`).textContent = data[`fan2MTX${i}`] || 'N/A';
                document.getElementById(`offSetMtx${i}`).textContent = data[`offSetMtx${i}`] || 'N/A';
            }

            statusDiv.textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`;
            statusDiv.style.color = '#0f0';

        } catch (error) {
            statusDiv.textContent = `Erro: ${error.message}`;
            statusDiv.style.color = '#f00';
            console.error('Erro ao carregar dados:', error);
        }
    }

    // ============ INICIALIZA√á√ÉO ============
    window.onload = function() {
        // Seleciona a op√ß√£o padr√£o (30s)
        const opcoes = document.querySelectorAll('.dropdown-item');
        opcoes.forEach(opcao => {
            if (opcao.textContent === '30s') {
                opcao.classList.add('selected');
            }
        });

        carregarDados();
        reiniciarTimerAtualizacao();
    };

</script>
</body>
</html>